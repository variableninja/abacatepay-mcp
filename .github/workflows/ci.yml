name: CI - VerificaÃ§Ãµes de Qualidade

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  ci:
    name: âœ… VerificaÃ§Ãµes ObrigatÃ³rias
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout do cÃ³digo
      uses: actions/checkout@v4

    - name: ğŸŸ¢ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'

    - name: ğŸ“¦ Instalar dependÃªncias
      run: npm ci

    - name: ğŸ” Auditoria de seguranÃ§a
      run: |
        echo "ğŸ” Verificando vulnerabilidades de seguranÃ§a..."
        npm audit --audit-level=high
        if [ $? -ne 0 ]; then
          echo "âŒ Vulnerabilidades de alta severidade encontradas!"
          echo "ğŸ’¡ Execute 'npm audit fix' para corrigir automaticamente"
          exit 1
        fi
        echo "âœ… Nenhuma vulnerabilidade crÃ­tica encontrada"

    - name: ğŸ§¹ VerificaÃ§Ã£o de cÃ³digo (ESLint)
      run: |
        echo "ğŸ§¹ Verificando qualidade do cÃ³digo..."
        npm run lint
        if [ $? -ne 0 ]; then
          echo "âŒ Problemas de qualidade de cÃ³digo encontrados!"
          echo "ğŸ’¡ Execute 'npm run lint:fix' para corrigir automaticamente"
          exit 1
        fi
        echo "âœ… CÃ³digo estÃ¡ seguindo os padrÃµes de qualidade"

    - name: ğŸ”§ VerificaÃ§Ã£o de tipos TypeScript
      run: |
        echo "ğŸ”§ Verificando tipos TypeScript..."
        npx tsc --noEmit
        if [ $? -ne 0 ]; then
          echo "âŒ Erros de tipo encontrados!"
          echo "ğŸ’¡ Corrija os erros de TypeScript antes de continuar"
          exit 1
        fi
        echo "âœ… Todos os tipos estÃ£o corretos"

    - name: ğŸ—ï¸ CompilaÃ§Ã£o do projeto
      run: |
        echo "ğŸ—ï¸ Compilando o projeto..."
        npm run build
        if [ $? -ne 0 ]; then
          echo "âŒ Falha na compilaÃ§Ã£o!"
          exit 1
        fi
        echo "âœ… Projeto compilado com sucesso"

    - name: ğŸ§ª VerificaÃ§Ã£o do script inspector
      run: |
        echo "ğŸ§ª Testando script inspector..."
        if [ ! -f "scripts/inspector.js" ]; then
          echo "âŒ Script inspector nÃ£o encontrado!"
          exit 1
        fi
        
        # Verifica sintaxe do script
        node -c scripts/inspector.js
        if [ $? -ne 0 ]; then
          echo "âŒ Script inspector tem erros de sintaxe!"
          exit 1
        fi
        
        echo "âœ… Script inspector estÃ¡ funcionando corretamente"

    - name: ğŸ” VerificaÃ§Ã£o de arquivos essenciais
      run: |
        echo "ğŸ” Verificando arquivos essenciais..."
        
        # Verifica se os arquivos compilados existem
        if [ ! -f "dist/index.js" ]; then
          echo "âŒ Arquivo principal compilado nÃ£o encontrado!"
          exit 1
        fi
        
        # Verifica se o package.json tem os scripts necessÃ¡rios
        if ! npm run --silent | grep -q "build\|start\|inspector"; then
          echo "âŒ Scripts npm essenciais nÃ£o encontrados!"
          exit 1
        fi
        
        echo "âœ… Todos os arquivos essenciais estÃ£o presentes"

    - name: ğŸ¯ Teste de importaÃ§Ã£o do MCP Server
      run: |
        echo "ğŸ¯ Testando se o MCP Server pode ser importado..."
        node -e "
          import('./dist/index.js').then(() => {
            console.log('âœ… MCP Server importado com sucesso');
            process.exit(0);
          }).catch(err => {
            console.error('âŒ Falha ao importar MCP Server:', err.message);
            process.exit(1);
          });
        "

    - name: ğŸ‰ Sucesso
      run: |
        echo ""
        echo "ğŸ‰ Todas as verificaÃ§Ãµes passaram com sucesso!"
        echo ""
        echo "ğŸ“‹ Resumo das verificaÃ§Ãµes:"
        echo "  âœ… DependÃªncias instaladas"
        echo "  âœ… SeguranÃ§a verificada"
        echo "  âœ… Qualidade de cÃ³digo aprovada"
        echo "  âœ… Tipos TypeScript corretos"
        echo "  âœ… CompilaÃ§Ã£o bem-sucedida"
        echo "  âœ… Script inspector funcional"
        echo "  âœ… Arquivos essenciais presentes"
        echo "  âœ… MCP Server importÃ¡vel"
        echo ""
        echo "ğŸš€ Pronto para merge! ğŸ¥‘" 